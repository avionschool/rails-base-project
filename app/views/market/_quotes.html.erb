<div class="row row-cols-1 row-cols-md-3 g-4">
    <% if @markets %>
        <% @market_data = {} %>
        <% @markets.each do |market| %>
            <div class="col">
                <% client = IEX::Api::Client.new() %>
                <% quote = client.quote(market.name) %>
                <% @market_data[market.id] ={ 
                    symbol: quote.symbol,
                    company_name:quote.company_name,
                    latest_price: quote.latest_price,
                    change_percent_s: quote.change_percent_s,
                    change: quote.change
                } %>
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title"><%= quote.symbol %></h5>
                            <button type="button" class="btn-close text-white-50" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted"><%= quote.company_name %></h6>
                        <p class="card-text">
                            $<%= quote.latest_price%><br>
                            <%= quote.change_percent_s %><br>
                            <%= quote.change%><br>
                        </p>
                        <div class="" id="market">
                            <%# <div class="chart-fill" id="chart-fill-positive"
                                data-dailychart-close="1289.0" data-dailychart-length="93"
                                data-dailychart-values="1292.2,1292.0,1292.1,1291.8,1291.8,1292.1,1291.9,1291.6,1291.7,1291.7,1291.6,1291.8,1291.6,1291.7,1292.0,1291.6,1291.4,1291.2,1290.5,1290.5,1290.6,1290.5,1290.4,1289.8,1289.5,1290.0,1289.6,1289.7,1289.1,1288.8,1289,1289.2,1289.4,1289.7,1289.7,1289.6,1289.2,1290.1,1290.3,1290.5,1290.7,1292.3,1292.5,1291.7,1292.1,1292.1,1292.6,1292.7,1292.8,1292.7,1292.2,1291.7,1292.1,1292.1,1291.7,1291.2,1291.7,1291.9,1291.6,1292.1,1292.5,1293.6,1293.3,1293.8,1293.9,1293.5,1293.7,1293.6,1294.1,1295.0,1296.9,1297.0,1296.3,1296.5,1296.6,1296.6,1296.1,1296.4,1296.1,1296.5,1296.7,1296.0,1296.1,1296.7,1296.1,1296.1,1296.2,1296.0,1296.1,1295.9,1295.7,1296.0,1296.4">
                            </div> %>
                        </div>
                        <div class="d-flex justify-content-end">
                            <%# Opens a modal if buy %>
                            <% if current_user.role_id == 3 %>
                                <%= button_to "Buy", show_stock_in_modal_path, method: :post, remote: true,
                                    class: "btn btn-primary",
                                    "data-bs-toggle" => "modal",
                                    "data-bs-target" => "#modal-create-stock",
                                    params: { market_id: market.id } %>
                            <% else %>
                                <%= form_with url: add_stock_to_market_path, method: :post, remote: true do |f| %>
                                    <%= f.hidden_field :name %>
                                    <%= hidden_field_tag :name, quote.symbol  %>
                                    <%= f.button "Look for Brokers", class: 'btn btn-primary', data: {disable_with: "<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Looking..."}  %>
                                <% end %>
                            <% end %>
                
                        </div>
                    </div>
                </div>
            </div>
        <% end %>
    <% end %>
</div>